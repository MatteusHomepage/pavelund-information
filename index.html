<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PÃ¥velund Skolan - Elev Portal</title>
      <link rel="icon" type="image/x-icon" href="goteborglogo.ico">

    <style>
        :root {
            --bg-dark: #121212;
            --bg-panel: #1e1e1e;
            --bg-hover: #2a2a2a;
            --accent: #3b82f6;
            --accent-hover: #2563eb;
            --text-main: #e2e8f0;
            --text-muted: #94a3b8;
            --border: #333;
            --danger: #ef4444;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background: var(--bg-dark);
            color: var(--text-main);
            overflow: hidden;
            height: 100vh;
        }


    .school-landing {
    height: 100vh;
    display: flex;
    flex-direction: column;
    

    background: linear-gradient(rgba(0, 0, 0, 0.3), rgba(0, 0, 0, 0.6)), 
                url('https://www.gp.se/images/article/d454d49b-b770-4d8a-a5ce-9409de139b9a/images/0npdNZpBU0RzrBB-3CK0hnzlW85s-REGULAR.jpg?width=1920&quality=75') no-repeat center center/cover;
    
    background-attachment: fixed;
    

    image-rendering: -webkit-optimize-contrast;
    image-rendering: high-quality;
}

        .school-header {
            background: rgba(30, 30, 30, 0.95);
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border);
            backdrop-filter: blur(10px);
        }

        .logo-area { display: flex; align-items: center; gap: 1rem; }
        .logo-icon { 
            width: 40px; height: 40px; 
            background: var(--accent); 
            color: white; 
            border-radius: 8px; 
            display: grid; place-items: center; font-weight: bold; font-size: 1.2rem;
        }
        .school-title h1 { font-size: 1.2rem; font-weight: 600; letter-spacing: 0.5px; }
        .school-title span { font-size: 0.8rem; color: var(--text-muted); text-transform: uppercase; }

.panic-settings {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
        }
        .panic-shortcut-hint {
            font-size: 0.7rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .panic-input-group {
            display: flex;
            gap: 8px;
        }
        .panic-input {
            background: #2a2a2a;
            border: 1px solid var(--border);
            border-radius: 4px;
            color: white;
            padding: 4px 12px;
            font-size: 0.85rem;
            width: 200px;
        }
        
.logo-img {
    width: 40px;
    height: 40px;
    border-radius: 8px;
    object-fit: cover;
}


        .nav-links a {
            color: var(--text-muted);
            text-decoration: none;
            margin-left: 2rem;
            font-size: 0.9rem;
            transition: color 0.2s;
        }
        .nav-links a:hover { color: var(--text-main); }

        .content-wrapper {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 2rem;
            gap: 4rem;
        }

        .welcome-text { max-width: 600px; }
        .welcome-text h2 { font-size: 3rem; margin-bottom: 1rem; line-height: 1.1; }
        .welcome-text p { font-size: 1.1rem; color: #ccc; margin-bottom: 2rem; line-height: 1.6; }

        .login-panel {
            background: rgba(30, 30, 30, 0.95);
            padding: 2.5rem;
            border-radius: 12px;
            width: 100%;
            max-width: 400px;
            border: 1px solid var(--border);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        }

        .login-panel h3 { margin-bottom: 0.5rem; }
        .login-panel p { color: var(--text-muted); font-size: 0.9rem; margin-bottom: 1.5rem; }

        .form-group { margin-bottom: 1.2rem; }
        .form-group label { display: block; margin-bottom: 0.5rem; font-size: 0.85rem; color: var(--text-muted); }
        .form-input {
            width: 100%;
            padding: 0.75rem;
            background: #2a2a2a;
            border: 1px solid #444;
            border-radius: 6px;
            color: white;
            font-size: 1rem;
        }
        .form-input:focus { outline: none; border-color: var(--accent); }

        .btn-primary {
            width: 100%;
            padding: 0.75rem;
            background: var(--accent);
            border: none;
            border-radius: 6px;
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
        }
        .btn-primary:hover { background: var(--accent-hover); }

        .error-msg { color: var(--danger); font-size: 0.85rem; margin-top: 1rem; display: none; text-align: center; }

     
        .chat-container { display: none; height: 100vh; display: flex; flex-direction: column; }
        
       
        .app-header {
            height: 60px;
            background: var(--bg-panel);
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 1.5rem;
        }
        .user-profile { display: flex; align-items: center; gap: 10px; cursor: pointer; }
        .avatar {
            width: 35px; height: 35px;
            border-radius: 50%;
            background: #444;
            display: grid; place-items: center;
            overflow: hidden; font-weight: 600; font-size: 0.9rem; color: #ccc;
            flex-shrink: 0;
        }
        .avatar img { width: 100%; height: 100%; object-fit: cover; }
        
        .logout-btn {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text-muted);
            padding: 6px 16px;
            border-radius: 6px;
            cursor: pointer;
        }

      
        .app-body { flex: 1; display: flex; overflow: hidden; }

       
        .sidebar {
            width: 300px;
            background: #181818;
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
        }

        .sidebar-tabs { display: flex; border-bottom: 1px solid var(--border); }
        .tab {
            flex: 1; padding: 1rem;
            background: transparent; border: none;
            color: var(--text-muted); cursor: pointer;
            border-bottom: 2px solid transparent;
        }
        .tab.active { color: white; border-bottom-color: var(--accent); background: #222; }

        .chat-list { flex: 1; overflow-y: auto; padding: 0.5rem; }
        
        .chat-item {
            display: flex; gap: 12px;
            padding: 12px;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.2s;
            user-select: none; 
        }
        .chat-item:hover { background: var(--bg-hover); }
        .chat-item.active { background: #252525; border-left: 3px solid var(--accent); }
        
        .chat-info { flex: 1; min-width: 0; }
        .chat-name { font-weight: 600; font-size: 0.95rem; display: flex; justify-content: space-between; }
        .chat-preview { font-size: 0.85rem; color: var(--text-muted); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-top: 4px; }
        .timestamp { font-size: 0.75rem; font-weight: normal; color: #666; }

        .fab-new {
            margin: 1rem;
            padding: 0.8rem;
            background: var(--bg-hover);
            color: var(--text-main);
            border: 1px dashed var(--border);
            border-radius: 8px;
            cursor: pointer;
            text-align: center;
        }

    
        .chat-view { flex: 1; display: flex; flex-direction: column; background: var(--bg-dark); position: relative; }
        
        .chat-view-header {
            padding: 0 1.5rem;
            height: 60px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: var(--bg-panel);
        }
        .header-info { display: flex; align-items: center; gap: 12px; }
        .header-actions { display: flex; gap: 10px; }
        
        .icon-btn {
            background: transparent; border: none;
            color: var(--text-muted); cursor: pointer;
            padding: 8px; border-radius: 6px; font-size: 1.1rem;
        }
        .icon-btn:hover { background: var(--bg-hover); color: var(--accent); }
        .icon-btn.danger:hover { color: var(--danger); }

        .messages-area {
            flex: 1;
            padding: 1.5rem;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .message { display: flex; gap: 10px; max-width: 70%; position: relative; }
        .message.sent { align-self: flex-end; flex-direction: row-reverse; }
        
        .msg-bubble {
            background: var(--bg-panel);
            padding: 10px 14px;
            border-radius: 12px;
            border-top-left-radius: 2px;
            border: 1px solid var(--border);
            position: relative;
        }
        .message.sent .msg-bubble {
            background: var(--accent);
            color: white;
            border: none;
            border-top-left-radius: 12px;
            border-top-right-radius: 2px;
        }

        .msg-bubble.deleted {
            background: transparent;
            border: 1px dashed #444;
            color: #666;
            font-style: italic;
        }
        .message.sent .msg-bubble.deleted {
            background: transparent;
            border: 1px dashed #444;
            color: #666;
        }
        
        .msg-sender { font-size: 0.75rem; color: var(--text-muted); margin-bottom: 4px; }
        .message.sent .msg-sender { display: none; }
        
        .msg-text { font-size: 0.95rem; line-height: 1.5; white-space: pre-wrap; }
        .msg-time { font-size: 0.7rem; opacity: 0.7; text-align: right; margin-top: 4px; }
        .msg-edited { font-size: 0.65rem; opacity: 0.6; margin-left: 5px; font-style: italic; }

       
        .msg-actions {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            display: none;
            gap: 5px;
        }
        .message:hover .msg-actions { display: flex; }
        .message.sent .msg-actions { left: -60px; }
        .message.received .msg-actions { right: -60px; }
        
        .action-mini {
            width: 24px; height: 24px;
            border-radius: 50%;
            background: var(--bg-panel);
            border: 1px solid var(--border);
            color: #aaa;
            display: grid; place-items: center;
            cursor: pointer; font-size: 12px;
        }
        .action-mini:hover { color: white; border-color: #666; }

       
        .input-area {
            padding: 1.5rem;
            background: var(--bg-panel);
            border-top: 1px solid var(--border);
            display: flex; gap: 10px;
        }

        .input-actions {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-right: 8px;
        }

        .action-btn {
            background: transparent;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            padding: 6px;
            border-radius: 6px;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .action-btn:hover { background: var(--bg-hover); color: var(--accent); }

        .msg-context-menu {
            position: absolute;
            background: var(--bg-panel);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 0.5rem 0;
            display: none;
            flex-direction: column;
            box-shadow: 0 4px 12px rgba(0,0,0,0.5);
            z-index: 10000;
            min-width: 120px;
        }

        .msg-context-menu .ctx-item {
            padding: 0.6rem 1rem;
            cursor: pointer;
            transition: background 0.2s;
        }

        .msg-context-menu .ctx-item:hover { background: var(--bg-hover); }

   .picker-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--bg-panel);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1.5rem;
            display: none;
            box-shadow: 0 8px 24px rgba(0,0,0,0.7);
            z-index: 1000;
            max-height: 400px;
            overflow-y: auto;
            overflow-x: hidden;
            width: 400px;
        }

     .emoji-grid {
            display: grid;
            grid-template-columns: repeat(10, 1fr);
            gap: 10px;
        }

        .emoji-item {
            font-size: 1.5rem;
            cursor: pointer;
            padding: 6px;
            border-radius: 6px;
            text-align: center;
            transition: background 0.2s;
        }

        .emoji-item:hover { background: var(--bg-hover); }

        .file-preview {
            display: flex;
            align-items: center;
            gap: 8px;
            background: var(--bg-hover);
            padding: 8px 12px;
            border-radius: 8px;
            margin-bottom: 8px;
            font-size: 0.9rem;
        }

        .file-preview button {
            background: transparent;
            border: none;
            color: var(--danger);
            cursor: pointer;
            padding: 4px;
        }

        .blank-chat-state {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-muted);
            font-size: 1.1rem;
        }

        .chat-input {
            flex: 1;
            padding: 12px;
            border-radius: 24px;
            border: 1px solid var(--border);
            background: #2a2a2a;
            color: white;
            resize: none;
            height: 46px;
            line-height: 20px;
        }
        .chat-input:focus { outline: none; border-color: var(--accent); }

   
        .ctx-menu {
            position: fixed;
            background: var(--bg-panel);
            border: 1px solid var(--border);
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
            border-radius: 8px;
            z-index: 5000;
            display: none;
            flex-direction: column;
            min-width: 160px;
            overflow: hidden;
            padding: 5px;
        }
        .ctx-item {
            padding: 10px 15px;
            font-size: 0.9rem;
            color: #e2e8f0;
            cursor: pointer;
            border-radius: 4px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .ctx-item:hover { background: var(--bg-hover); }
        .ctx-item.danger { color: var(--danger); }
        .ctx-item.danger:hover { background: rgba(239, 68, 68, 0.1); }

  
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8);
            backdrop-filter: blur(4px);
            display: none;
            align-items: center; justify-content: center;
            z-index: 1000;
        }
        .modal-box {
            background: var(--bg-panel);
            padding: 2rem;
            border-radius: 12px;
            width: 90%; max-width: 450px;
            border: 1px solid var(--border);
        }
        .modal-list { display: flex; flex-direction: column; gap: 0.5rem; max-height: 300px; overflow-y: auto; margin: 1rem 0; }
        .user-row {
            display: flex; align-items: center; gap: 1rem;
            padding: 0.8rem;
            background: #252525;
            border-radius: 8px;
            cursor: pointer;
        }
        .user-row:hover { background: #333; }

  
        .vc-overlay {
            position: fixed; top: 20px; right: 20px;
            background: #1a1a1a;
            border: 1px solid #333;
            padding: 1rem;
            border-radius: 12px;
            display: none;
            align-items: center; gap: 1rem;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            z-index: 2000;
        }
        .vc-pulse {
            width: 12px; height: 12px;
            background: #ef4444;
            border-radius: 50%;
            animation: pulse 1s infinite;
        }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.4; } 100% { opacity: 1; } }

        
      
        .hidden { display: none !important; }
        
        .input-area {
            padding: 1.5rem;
            background: var(--bg-panel);
            border-top: 1px solid var(--border);
            display: flex; gap: 10px;
        }

        .input-bar {
            padding: 1.5rem;
            background: var(--bg-panel);
            border-top: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
    </style>
</head>
<body>

    <div id="page-login" class="school-landing">
        <div class="school-header">
            <div class="logo-area">
                <img src="goteborglogo.png" class="logo-img" alt="PÃ¥velund Skolan">
                <div class="school-title">
                    <h1>PÃ¥velund Skolan</h1>
                    <span>Elev Portal</span>
                </div>
            </div>
            <div class="nav-links"> 
                <a href="#">Information</a>
                <a href="#">HjÃ¤lp</a>
            </div>
        </div>

        <div class="content-wrapper">
            <div class="welcome-text">
                <h2>PÃ¥velundskolan. Grow with us.</h2>
                <p>VÃ¤lkomen till PÃ¥velundskolans elevmiljÃ¶. FÃ¥ tillgÃ¥ng till dina kurser, gÃ¥ med i mÃ¶ten och hantera din akademisk profil hÃ¤r.</p>
            </div>
            
            <div class="login-panel">
                <h3>Elev Ã…tkomst</h3>
                <p>Ange din elev identifieringskod fÃ¶r att fortsÃ¤tta.</p>
                
                <div class="form-group">
                    <label>Identifieringskod:</label>
                    <input type="password" id="loginCode" class="form-input" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
                </div>
                
                <button onclick="attemptLogin()" class="btn-primary">FortsÃ¤tt</button>
                <div id="loginError" class="error-msg">Ã…tkomst nekad: Ogiltiga inloggningsuppgifter</div>
            </div>
        </div>
    </div>

    <div id="page-chat" class="chat-container hidden">
 <div class="app-header">
           <div class="user-profile" onclick="openProfileModal()">
                <div class="avatar" id="myAvatar"></div>
                <span id="myName">Loading...</span>
            </div>

            <div class="panic-settings">
                <span class="panic-shortcut-hint">Panic Shortcut: Ctrl + Shift + P</span>
                <div class="panic-input-group">
                    <input type="text" id="panicUrlInput" class="panic-input" placeholder="https://docs.google.com">
                    <button class="logout-btn" style="padding: 2px 10px;" onclick="updatePanicUrl()">Set</button>
                </div>
            </div>

            <button class="logout-btn" onclick="logout()">Sign Out</button>
        </div>

        <div class="app-body">
            <div class="sidebar">
                <div class="sidebar-tabs">
                    <button class="tab active" onclick="setTab('dms')">Direct Messages</button>
                    <button class="tab" onclick="setTab('groups')">Groups</button>
                </div>
                
                <div id="chatList" class="chat-list">
                    </div>

                <div class="fab-new" onclick="openNewChatModal()">
                    + Add
                </div>
            </div>

            <div class="chat-view">
                <div id="emptyState" class="blank-chat-state">
            Select a chat to start messaging
        </div>

                <div id="activeChat" class="hidden" style="flex:1; display:flex; flex-direction:column; height:100%;">
                    <div class="chat-view-header">
                        <div class="header-info">
                            <div class="avatar" id="currentChatAvatar"></div>
                            <h3 id="currentChatName">Name</h3>
                        </div>
                        <div class="header-actions">
                            <button class="icon-btn" title="Voice Chat" onclick="toggleVoiceChat()">Voice Chat</button>
                        </div>
                    </div>

                    <div id="messagesList" class="messages-area">
                        </div> 

                
<div class="input-bar">
                        <div id="filePreview" style="display: none;" class="file-preview">
                            <span id="fileName"></span>
                            <button onclick="clearFile()">âœ•</button>
                        </div>
                        <div style="display: flex; width: 100%; align-items: center; gap: 10px;">
                            <div class="input-actions">
                                <button class="action-btn" onclick="toggleEmojiPicker()" title="Add emoji">ðŸ˜Š</button>
                                <button class="action-btn" onclick="triggerFileUpload()" title="Attach file">ðŸ“Ž</button>
                            </div>
                            <input type="file" id="fileInput" style="display: none;" onchange="handleFileSelect(event)">
                            <input type="text" id="msgInput" class="chat-input" placeholder="Type a message..." onkeypress="if(event.key==='Enter') sendMessage()">
                            <button class="btn-primary" style="width:auto; padding:0 1.5rem; height:46px;" onclick="sendMessage()">Send</button>
                        </div>
                    </div>

                <div id="emojiPicker" class="picker-popup">
                    <div class="emoji-grid" id="emojiGrid"></div>
                </div>

                <div id="msgContextMenu" class="msg-context-menu"></div>

                </div>
            </div>
        </div>
    </div>

    <div id="sidebarContextMenu" class="ctx-menu">
        </div>

    <div id="modalNewChat" class="modal-overlay">
        <div class="modal-box">
            <h3 id="modalTitle">New Message</h3>
            <div id="modalList" class="modal-list"></div>
            <div style="margin-top:1rem; display:flex; gap:10px; justify-content:flex-end;">
                <button class="logout-btn" onclick="closeModals()">Cancel</button>
                <button id="createGroupBtn" class="btn-primary hidden" style="width:auto" onclick="finalizeGroup()">Create</button>
            </div>
        </div>
    </div>

    <div id="modalRename" class="modal-overlay">
        <div class="modal-box">
            <h3>Rename Group</h3>
            <input type="text" id="renameInput" class="form-input" style="margin:1rem 0;">
            <div style="display:flex; gap:10px;">
                <button class="btn-primary" onclick="saveGroupName()">Save</button>
                <button class="logout-btn" onclick="closeModals()">Cancel</button>
            </div>
        </div>
    </div>

    <div id="modalEditMsg" class="modal-overlay">
        <div class="modal-box">
            <h3>Edit Message</h3>
            <input type="text" id="editMsgInput" class="form-input" style="margin:1rem 0;">
            <div style="display:flex; gap:10px;">
                <button class="btn-primary" onclick="saveEditedMessage()">Update</button>
                <button class="logout-btn" onclick="closeModals()">Cancel</button>
            </div>
        </div>
    </div>

    <div id="vcOverlay" class="vc-overlay">
        <div class="vc-pulse"></div>
        <div>
            <div style="font-weight:600; font-size:0.9rem;">Voice Active</div>
            <div style="font-size:0.75rem; color:#888;">Microphone On</div>
        </div>
        <button onclick="toggleVoiceChat()" style="background:#333; color:white; border:none; padding:8px 12px; border-radius:6px; cursor:pointer;">End</button>
    </div>

<script src="/socket.io/socket.io.js"></script>
<script>
  
    let PANIC_URL = "https://www.google.com";
    let currentUser = null;
    let currentChatId = null;
    let allChats = []; 
    let allUsers = []; 
    let activeTab = 'dms'; 
    
    const socket = io();

 
    const pageLogin = document.getElementById('page-login');
    const pageChat = document.getElementById('page-chat');
    const loginInput = document.getElementById('loginCode');
    const errorMsg = document.getElementById('loginError');
    const chatListEl = document.getElementById('chatList');
    const messagesListEl = document.getElementById('messagesList');
    const activeChatPanel = document.getElementById('activeChat');
    const emptyStatePanel = document.getElementById('emptyState');
    const ctxMenu = document.getElementById('sidebarContextMenu');
    
    
    const modalNewChat = document.getElementById('modalNewChat');
    const modalRename = document.getElementById('modalRename');
    const modalList = document.getElementById('modalList');
    const modalTitle = document.getElementById('modalTitle');
    const createGroupBtn = document.getElementById('createGroupBtn');

   function updatePanicUrl() {
        let val = document.getElementById('panicUrlInput').value.trim();
        if (!val) return;
        if (!val.startsWith('http')) val = 'https://' + val;
        PANIC_URL = val;
        alert('Panic URL updated to: ' + PANIC_URL);
    }

    document.addEventListener('keydown', (e) => {
        if (e.ctrlKey && e.shiftKey && (e.key === 'p' || e.key === 'P')) {
            e.preventDefault();
            window.location.replace(PANIC_URL);
        }
    });
  
   function attemptLogin(providedCode) {
    const code = providedCode || loginInput.value.trim();
    if (code) {
        localStorage.setItem('savedLoginCode', code);
        socket.emit('login', code);
        if (!providedCode) {
            pageLogin.classList.add('hidden');
            pageChat.classList.remove('hidden');
        }
    }
}

socket.on('login_success', (user) => {
    currentUser = user;
    if ("Notification" in window) {
        Notification.requestPermission();
    }
    document.getElementById('myName').innerText = user.name;
    document.getElementById('myAvatar').innerHTML = 
        `<img src="https://ui-avatars.com/api/?name=${user.name}&background=random" alt="">`;
});

    socket.on('login_fail', () => {
        errorMsg.style.display = 'block';
        setTimeout(() => errorMsg.style.display = 'none', 3000);
    });

    socket.on('user_list', (users) => {
        allUsers = users;
    });

    socket.on('chat_exists', (chatId) => {
        alert('You already have a chat with this person!');
        openChat(chatId);
        closeModals();
    });
 
    function setTab(tab) {
        activeTab = tab;
       
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      
        const buttons = document.querySelectorAll('.tab');
        if(tab === 'dms') buttons[0].classList.add('active');
        else buttons[1].classList.add('active');
        
        renderChatList();
    }

    socket.on('update_chats', (chats) => {
        allChats = chats;
        renderChatList();
    });

   function renderChatList() {
        chatListEl.innerHTML = '';
        
        const filtered = allChats.filter(c => {
            if (activeTab === 'groups') return c.type === 'group';
            return c.type === 'dm';
        });

        filtered.forEach(chat => {
            const div = document.createElement('div');
            div.className = `chat-item ${currentChatId === chat.id ? 'active' : ''}`;
            div.onclick = () => openChat(chat.id);
            div.oncontextmenu = (e) => showContextMenu(e, chat.id);
            
            let displayName = chat.name;
            if (chat.type === 'dm') {
                
                const otherUserId = chat.members.find(id => id !== currentUser.id);
                const otherUser = allUsers.find(u => u.id === otherUserId);
                if (otherUser) {
                    displayName = otherUser.name;
                }
            }

            div.innerHTML = `
                <div class="avatar"><span>${displayName.substring(0,2).toUpperCase()}</span></div>
                <div class="chat-info">
                    <div class="chat-name">${displayName}</div>
                    <div class="chat-preview">Click to open</div>
                </div>
            `;
            chatListEl.appendChild(div);
        });
    }

   function openChat(id) {
        currentChatId = id;
        const chat = allChats.find(c => c.id === id);
        
        emptyStatePanel.classList.remove('hidden');
        emptyStatePanel.style.display = 'none';
        activeChatPanel.classList.remove('hidden');
        
        let displayName = chat.name;
        if (chat.type === 'dm') {
            const otherUserId = chat.members.find(mid => mid !== currentUser.id);
            const otherUser = allUsers.find(u => u.id === otherUserId);
            if (otherUser) {
                displayName = otherUser.name;
            }
        }
        
        document.getElementById('currentChatName').innerText = displayName;
        document.getElementById('currentChatAvatar').innerText = displayName.substring(0,2).toUpperCase();
        
        renderChatList(); 
        
        messagesListEl.innerHTML = '<div style="padding:20px; text-align:center; opacity:0.5">Loading...</div>';
        socket.emit('get_messages', id);
    }


    socket.on('history_data', ({ chatId, messages }) => {
        if (chatId !== currentChatId) return;
        messagesListEl.innerHTML = '';
        messages.forEach(msg => renderMessage(msg));
        scrollToBottom();
    });

socket.on('new_msg', ({ chatId, message }) => {
    if (currentChatId === chatId) {
        renderMessage(message);
        scrollToBottom();
    }
    if (currentUser && message.senderId !== currentUser.id) {
        if (Notification.permission === "granted") {
            const n = new Notification(`New message from ${message.senderName}`, {
                body: message.text || "Sent an attachment",
                icon: "goteborglogo.ico"
            });
            n.onclick = () => {
                window.focus();
                if (pageChat.classList.contains('hidden')) {
                    pageLogin.classList.add('hidden');
                    pageChat.classList.remove('hidden');
                }
                openChat(chatId);
            };
        }
    }
});

function sendMessage() {
        const input = document.getElementById('msgInput');
        const text = input.value.trim();
        if (!text && !selectedFile) return;
        if (!currentChatId) return;

        if (selectedFile) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const messageData = { 
                    chatId: currentChatId, 
                    text: text || '',
                    file: {
                        name: selectedFile.name,
                        data: e.target.result,
                        type: selectedFile.type
                    }
                };
                socket.emit('send_msg', messageData);
                clearFile();
                input.value = '';
            };
            reader.readAsDataURL(selectedFile);
        } else {
            socket.emit('send_msg', { chatId: currentChatId, text });
            input.value = '';
        }
    }

function renderMessage(msg) {
        const isMe = msg.senderId === currentUser.id;
        const div = document.createElement('div');
        div.className = `message ${isMe ? 'sent' : 'received'}`;
        div.dataset.msgId = msg.id;
        
        if (msg.deleted) {
            div.innerHTML = `
                <div class="msg-bubble deleted">
                    <div class="msg-text">This message has been deleted</div>
                </div>`;
        } else {
            div.oncontextmenu = (e) => {
                showMessageContextMenu(e, msg.id, isMe);
            };
            
            const editedLabel = msg.edited ? ' <span style="font-size:0.75rem;opacity:0.6">(edited)</span>' : '';
            const fileAttachment = msg.file ? `<a href="${msg.file.data}" download="${msg.file.name}" style="margin-top:8px;padding:8px;background:rgba(0,0,0,0.2);border-radius:6px;font-size:0.85rem;color:white;display:block;text-decoration:none;">ðŸ“Ž ${msg.file.name}</a>` : '';
            
            div.innerHTML = `
                <div class="msg-bubble">
                    <div class="msg-sender">${msg.senderName}</div>
                    <div class="msg-text">${msg.text}${editedLabel}</div>
                    ${fileAttachment}
                    <div class="msg-time">${new Date(msg.timestamp).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</div>
                </div>`;
        }
        messagesListEl.appendChild(div);
    }

    function scrollToBottom() {
        messagesListEl.scrollTop = messagesListEl.scrollHeight;
    }


    let selectedChatId = null;
    function showContextMenu(e, id) {
        e.preventDefault();
        selectedChatId = id;
        ctxMenu.style.display = 'flex';
        ctxMenu.style.left = e.pageX + 'px';
        ctxMenu.style.top = e.pageY + 'px';
        
        ctxMenu.innerHTML = `
            <div class="ctx-item" onclick="openRenameModal()">Rename</div>
            <div class="ctx-item danger" onclick="deleteChat()">Delete</div>
        `;
    }
    document.addEventListener('click', () => ctxMenu.style.display = 'none');


    let selectedMembers = [];

    function openNewChatModal() {
        modalNewChat.style.display = 'flex';
        modalTitle.innerText = activeTab === 'groups' ? 'New Group' : 'New Direct Message';
        modalList.innerHTML = '';
        selectedMembers = [];
        
        
        allUsers.forEach(u => {
            if (u.id === currentUser.id) return; 
            
            const row = document.createElement('div');
            row.className = 'user-row';
            row.innerHTML = `
                <div class="avatar"><span>${u.name.charAt(0)}</span></div>
                <span>${u.name}</span>
            `;
            row.onclick = () => {
               
                if (selectedMembers.includes(u.id)) {
                    selectedMembers = selectedMembers.filter(id => id !== u.id);
                    row.style.background = '#252525';
                } else {
                    selectedMembers.push(u.id);
                    row.style.background = '#3b82f6'; 
                }
            };
            modalList.appendChild(row);
        });

     
        createGroupBtn.classList.remove('hidden');
    }

function finalizeGroup() {
        if (selectedMembers.length === 0) return alert("Select at least one person!");

        if (activeTab === 'dms') {
            if (selectedMembers.length > 1) {
                return alert("You can only create a DM with one person at a time!");
            }
            const otherUser = allUsers.find(u => u.id === selectedMembers[0]);
            socket.emit('create_chat', { name: otherUser.name, type: 'dm', members: selectedMembers });
        } else {
            const name = prompt("Name this group:");
            if (!name) return;
            socket.emit('create_chat', { name, type: 'group', members: selectedMembers });
        }
        closeModals();
    }

 
    function openRenameModal() {
        modalRename.style.display = 'flex';
    }
    
    function saveGroupName() {
        const input = document.getElementById('renameInput');
        if (input.value && selectedChatId) {
            socket.emit('rename_chat', { chatId: selectedChatId, newName: input.value });
        }
        closeModals();
    }

    function deleteChat() {
        if (confirm("Delete this chat?")) {
            socket.emit('delete_chat', selectedChatId);
        }
    }

  
    function closeModals() {
        document.querySelectorAll('.modal-overlay').forEach(m => m.style.display = 'none');
    }
    
  function logout() {
    localStorage.removeItem('savedLoginCode');
    location.reload();
}

    function toggleVoiceChat() {
        const vc = document.getElementById('vcOverlay');
        vc.style.display = vc.style.display === 'flex' ? 'none' : 'flex';
    }

 
    let selectedMessageId = null;
    const msgCtxMenu = document.getElementById('msgContextMenu');

 function showMessageContextMenu(e, messageId, isOwner) {
        e.preventDefault();
        selectedMessageId = messageId;
        
        if (!isOwner) return;
        
        msgCtxMenu.style.display = 'flex';
        msgCtxMenu.style.left = e.pageX + 'px';
        msgCtxMenu.style.top = e.pageY + 'px';
        
        msgCtxMenu.innerHTML = `
            <div class="ctx-item" onclick="editMessage()">Edit</div>
            <div class="ctx-item danger" onclick="deleteMessage()">Delete</div>
        `;
    }

    function editMessage() {
        const msgDiv = document.querySelector(`[data-msg-id="${selectedMessageId}"]`);
        if (!msgDiv) return;
        
        const textEl = msgDiv.querySelector('.msg-text');
        const currentText = textEl.textContent.replace(' (edited)', '').trim();
        const newText = prompt("Edit message:", currentText);
        
        if (newText && newText !== currentText) {
            socket.emit('edit_msg', { chatId: currentChatId, messageId: selectedMessageId, newText });
        }
        msgCtxMenu.style.display = 'none';
    }

    function deleteMessage() {
        socket.emit('delete_msg', { chatId: currentChatId, messageId: selectedMessageId });
        msgCtxMenu.style.display = 'none';
    }

    socket.on('msg_edited', ({ chatId, messageId, newText }) => {
        if (chatId !== currentChatId) return;
        const msgDiv = document.querySelector(`[data-msg-id="${messageId}"]`);
        if (msgDiv) {
            const textEl = msgDiv.querySelector('.msg-text');
            textEl.innerHTML = newText + ' <span style="font-size:0.75rem;opacity:0.6">(edited)</span>';
        }
    });

  socket.on('msg_deleted', ({ chatId, messageId }) => {
        if (chatId !== currentChatId) return;
        const msgDiv = document.querySelector(`[data-msg-id="${messageId}"]`);
        if (msgDiv) {
            const bubble = msgDiv.querySelector('.msg-bubble');
            bubble.classList.add('deleted');
            bubble.innerHTML = '<div class="msg-text">This message has been deleted</div>';
        }
    });

 
    let selectedFile = null;
    const fileInput = document.getElementById('fileInput');
    const filePreview = document.getElementById('filePreview');
    const emojiPicker = document.getElementById('emojiPicker');
    const emojiGrid = document.getElementById('emojiGrid');

    const emojis = ['ðŸ˜€','ðŸ˜ƒ','ðŸ˜„','ðŸ˜','ðŸ˜†','ðŸ˜…','ðŸ¤£','ðŸ˜‚','ðŸ™‚','ðŸ™ƒ','ðŸ˜‰','ðŸ˜Š','ðŸ˜‡','ðŸ¥°','ðŸ˜','ðŸ¤©','ðŸ˜˜','ðŸ˜—','ðŸ˜š','ðŸ˜™','ðŸ¥²','ðŸ˜‹','ðŸ˜›','ðŸ˜œ','ðŸ¤ª','ðŸ˜','ðŸ¤‘','ðŸ¤—','ðŸ¤­','ðŸ¤«','ðŸ¤”','ðŸ¤','ðŸ¤¨','ðŸ˜','ðŸ˜‘','ðŸ˜¶','ðŸ˜','ðŸ˜’','ðŸ™„','ðŸ˜¬','ðŸ¤¥','ðŸ˜Œ','ðŸ˜”','ðŸ˜ª','ðŸ¤¤','ðŸ˜´','ðŸ˜·','ðŸ¤’','ðŸ¤•','ðŸ¤¢','ðŸ¤®','ðŸ¤§','ðŸ¥µ','ðŸ¥¶','ðŸ¥´','ðŸ˜µ','ðŸ¤¯','ðŸ¤ ','ðŸ¥³','ðŸ¥¸','ðŸ˜Ž','ðŸ¤“','ðŸ§','ðŸ˜•','ðŸ˜Ÿ','ðŸ™','â˜¹ï¸','ðŸ˜®','ðŸ˜¯','ðŸ˜²','ðŸ˜³','ðŸ¥º','ðŸ˜¦','ðŸ˜§','ðŸ˜¨','ðŸ˜°','ðŸ˜¥','ðŸ˜¢','ðŸ˜­','ðŸ˜±','ðŸ˜–','ðŸ˜£','ðŸ˜ž','ðŸ˜“','ðŸ˜©','ðŸ˜«','ðŸ¥±','ðŸ˜¤','ðŸ˜¡','ðŸ˜ ','ðŸ¤¬','ðŸ‘','ðŸ‘Ž','ðŸ‘','ðŸ™Œ','ðŸ‘‹','ðŸ¤š','âœ‹','ðŸ–','ðŸ––','ðŸ‘Œ','ðŸ¤Œ','ðŸ¤','âœŒï¸','ðŸ¤ž','ðŸ¤Ÿ','ðŸ¤˜','ðŸ¤™','ðŸ‘ˆ','ðŸ‘‰','ðŸ‘†','ðŸ‘‡','â˜ï¸','ðŸ‘','ðŸ‘Ž','âœŠ','ðŸ‘Š','ðŸ¤›','ðŸ¤œ','ðŸ‘','ðŸ™Œ','ðŸ‘','ðŸ¤²','ðŸ¤','ðŸ™','âœï¸','ðŸ’…','ðŸ¤³','ðŸ’ª','ðŸ¦¾','ðŸ¦¿','ðŸ¦µ','ðŸ¦¶','ðŸ‘‚','ðŸ¦»','ðŸ‘ƒ','ðŸ§ ','ðŸ«€','ðŸ«','ðŸ¦·','ðŸ¦´','ðŸ‘€','ðŸ‘','ðŸ‘…','ðŸ‘„','ðŸ’‹','ðŸ©¸'];

    emojis.forEach(emoji => {
        const span = document.createElement('span');
        span.className = 'emoji-item';
        span.textContent = emoji;
        span.onclick = () => insertEmoji(emoji);
        emojiGrid.appendChild(span);
    });

    function toggleEmojiPicker() {
        emojiPicker.style.display = emojiPicker.style.display === 'none' ? 'block' : 'none';
    }

    function insertEmoji(emoji) {
        const input = document.getElementById('msgInput');
        input.value += emoji;
        input.focus();
        emojiPicker.style.display = 'none';
    }

    function triggerFileUpload() {
        fileInput.click();
    }

    function handleFileSelect(event) {
        const file = event.target.files[0];
        if (file) {
            selectedFile = file;
            document.getElementById('fileName').textContent = file.name;
            filePreview.style.display = 'flex';
        }
    }

    function clearFile() {
        selectedFile = null;
        fileInput.value = '';
        filePreview.style.display = 'none';
    }

    document.addEventListener('click', (e) => {
        if (!emojiPicker.contains(e.target) && !e.target.classList.contains('action-btn')) {
            emojiPicker.style.display = 'none';
        }
        if (!msgCtxMenu.contains(e.target)) {
            msgCtxMenu.style.display = 'none';
        }
    });

    window.addEventListener('load', () => {
    const savedCode = localStorage.getItem('savedLoginCode');
    if (savedCode) {
        attemptLogin(savedCode);
    }
});
</script>

</body>
</html>
