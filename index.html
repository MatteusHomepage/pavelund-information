<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>P√•velund Skolan - Elev Portal</title>
      <link rel="icon" type="image/x-icon" href="goteborglogo.ico">

    <style>
        :root {
            --bg-dark: #121212;
            --bg-panel: #1e1e1e;
            --bg-hover: #2a2a2a;
            --accent: #3b82f6;
            --accent-hover: #2563eb;
            --text-main: #e2e8f0;
            --text-muted: #94a3b8;
            --border: #333;
            --danger: #ef4444;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background: var(--bg-dark);
            color: var(--text-main);
            overflow: hidden;
            height: 100vh;
        }


    .school-landing {
    height: 100vh;
    display: flex;
    flex-direction: column;
    

    background: linear-gradient(rgba(0, 0, 0, 0.3), rgba(0, 0, 0, 0.6)), 
                url('https://www.gp.se/images/article/d454d49b-b770-4d8a-a5ce-9409de139b9a/images/0npdNZpBU0RzrBB-3CK0hnzlW85s-REGULAR.jpg?width=1920&quality=75') no-repeat center center/cover;
    
    background-attachment: fixed;
    

    image-rendering: -webkit-optimize-contrast;
    image-rendering: high-quality;
}

        .school-header {
            background: rgba(30, 30, 30, 0.95);
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border);
            backdrop-filter: blur(10px);
        }

        .logo-area { display: flex; align-items: center; gap: 1rem; }
        .logo-icon { 
            width: 40px; height: 40px; 
            background: var(--accent); 
            color: white; 
            border-radius: 8px; 
            display: grid; place-items: center; font-weight: bold; font-size: 1.2rem;
        }
        .school-title h1 { font-size: 1.2rem; font-weight: 600; letter-spacing: 0.5px; }
        .school-title span { font-size: 0.8rem; color: var(--text-muted); text-transform: uppercase; }

.panic-settings {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
        }
        .panic-shortcut-hint {
            font-size: 0.7rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .panic-input-group {
            display: flex;
            gap: 8px;
        }
        .panic-input {
            background: #2a2a2a;
            border: 1px solid var(--border);
            border-radius: 4px;
            color: white;
            padding: 4px 12px;
            font-size: 0.85rem;
            width: 200px;
        }
        
.logo-img {
    width: 40px;
    height: 40px;
    border-radius: 8px;
    object-fit: cover;
}


        .nav-links a {
            color: var(--text-muted);
            text-decoration: none;
            margin-left: 2rem;
            font-size: 0.9rem;
            transition: color 0.2s;
        }
        .nav-links a:hover { color: var(--text-main); }

        .content-wrapper {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 2rem;
            gap: 4rem;
        }

        .welcome-text { max-width: 600px; }
        .welcome-text h2 { font-size: 3rem; margin-bottom: 1rem; line-height: 1.1; }
        .welcome-text p { font-size: 1.1rem; color: #ccc; margin-bottom: 2rem; line-height: 1.6; }

        .login-panel {
            background: rgba(30, 30, 30, 0.95);
            padding: 2.5rem;
            border-radius: 12px;
            width: 100%;
            max-width: 400px;
            border: 1px solid var(--border);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        }

        .login-panel h3 { margin-bottom: 0.5rem; }
        .login-panel p { color: var(--text-muted); font-size: 0.9rem; margin-bottom: 1.5rem; }

        .form-group { margin-bottom: 1.2rem; }
        .form-group label { display: block; margin-bottom: 0.5rem; font-size: 0.85rem; color: var(--text-muted); }
        .form-input {
            width: 100%;
            padding: 0.75rem;
            background: #2a2a2a;
            border: 1px solid #444;
            border-radius: 6px;
            color: white;
            font-size: 1rem;
        }
        .form-input:focus { outline: none; border-color: var(--accent); }

        .btn-primary {
            width: 100%;
            padding: 0.75rem;
            background: var(--accent);
            border: none;
            border-radius: 6px;
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
        }
        .btn-primary:hover { background: var(--accent-hover); }

        .error-msg { color: var(--danger); font-size: 0.85rem; margin-top: 1rem; display: none; text-align: center; }

     
        .chat-container { display: none; height: 100vh; display: flex; flex-direction: column; }
        
       
        .app-header {
            height: 60px;
            background: var(--bg-panel);
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 1.5rem;
        }
        .user-profile { display: flex; align-items: center; gap: 10px; cursor: pointer; }
        .avatar {
            width: 35px; height: 35px;
            border-radius: 50%;
            background: #444;
            display: grid; place-items: center;
            overflow: hidden; font-weight: 600; font-size: 0.9rem; color: #ccc;
            flex-shrink: 0;
        }
        .avatar img { width: 100%; height: 100%; object-fit: cover; }
        
        .logout-btn {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text-muted);
            padding: 6px 16px;
            border-radius: 6px;
            cursor: pointer;
        }

      
        .app-body { flex: 1; display: flex; overflow: hidden; }

       
        .sidebar {
            width: 300px;
            background: #181818;
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
        }

        .sidebar-tabs { display: flex; border-bottom: 1px solid var(--border); }
        .tab {
            flex: 1; padding: 1rem;
            background: transparent; border: none;
            color: var(--text-muted); cursor: pointer;
            border-bottom: 2px solid transparent;
        }
        .tab.active { color: white; border-bottom-color: var(--accent); background: #222; }

        .chat-list { flex: 1; overflow-y: auto; padding: 0.5rem; }
        
        .chat-item {
            display: flex; gap: 12px;
            padding: 12px;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.2s;
            user-select: none; 
        }
        .chat-item:hover { background: var(--bg-hover); }
        .chat-item.active { background: #252525; border-left: 3px solid var(--accent); }
        
        .chat-info { flex: 1; min-width: 0; }
        .chat-name { font-weight: 600; font-size: 0.95rem; display: flex; justify-content: space-between; }
        .chat-preview { font-size: 0.85rem; color: var(--text-muted); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-top: 4px; }
        .timestamp { font-size: 0.75rem; font-weight: normal; color: #666; }

        .fab-new {
            margin: 1rem;
            padding: 0.8rem;
            background: var(--bg-hover);
            color: var(--text-main);
            border: 1px dashed var(--border);
            border-radius: 8px;
            cursor: pointer;
            text-align: center;
        }

    
        .chat-view { flex: 1; display: flex; flex-direction: column; background: var(--bg-dark); position: relative; }
        
        .chat-view-header {
            padding: 0 1.5rem;
            height: 60px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: var(--bg-panel);
        }
        .header-info { display: flex; align-items: center; gap: 12px; }
        .header-actions { display: flex; gap: 10px; }
        
        .icon-btn {
            background: transparent; border: none;
            color: var(--text-muted); cursor: pointer;
            padding: 8px; border-radius: 6px; font-size: 1.1rem;
        }
        .icon-btn:hover { background: var(--bg-hover); color: var(--accent); }
        .icon-btn.danger:hover { color: var(--danger); }

        .messages-area {
            flex: 1;
            padding: 1.5rem;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .message { display: flex; gap: 10px; max-width: 70%; position: relative; }
        .message.sent { align-self: flex-end; flex-direction: row-reverse; }
        
        .msg-bubble {
            background: var(--bg-panel);
            padding: 10px 14px;
            border-radius: 12px;
            border-top-left-radius: 2px;
            border: 1px solid var(--border);
            position: relative;
        }
        .message.sent .msg-bubble {
            background: var(--accent);
            color: white;
            border: none;
            border-top-left-radius: 12px;
            border-top-right-radius: 2px;
        }

        .msg-bubble.deleted {
            background: transparent;
            border: 1px dashed #444;
            color: #666;
            font-style: italic;
        }
        .message.sent .msg-bubble.deleted {
            background: transparent;
            border: 1px dashed #444;
            color: #666;
        }
        
        .msg-sender { font-size: 0.75rem; color: var(--text-muted); margin-bottom: 4px; }
        .message.sent .msg-sender { display: none; }
        
        .msg-text { font-size: 0.95rem; line-height: 1.5; white-space: pre-wrap; }
        .msg-time { font-size: 0.7rem; opacity: 0.7; text-align: right; margin-top: 4px; }
        .msg-edited { font-size: 0.7rem; color: #888; margin-left: 5px; font-style: italic; }
        .msg-text.deleted-text { color: #888; font-style: italic; }

       
        .msg-actions {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            display: none;
            gap: 5px;
        }
        .message:hover .msg-actions { display: flex; }
        .message.sent .msg-actions { left: -60px; }
        .message.received .msg-actions { right: -60px; }
        
        .action-mini {
            width: 24px; height: 24px;
            border-radius: 50%;
            background: var(--bg-panel);
            border: 1px solid var(--border);
            color: #aaa;
            display: grid; place-items: center;
            cursor: pointer; font-size: 12px;
        }
        .action-mini:hover { color: white; border-color: #666; }

       
        .input-area {
            padding: 1.5rem;
            background: var(--bg-panel);
            border-top: 1px solid var(--border);
            display: flex; gap: 10px;
        }

        .input-actions {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-right: 8px;
        }

.action-btn {
            background: transparent;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            padding: 8px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
        .action-btn:hover { background: var(--bg-hover); color: var(--accent); }
        .action-btn svg { width: 20px; height: 20px; stroke: currentColor; fill: none; stroke-width: 2; stroke-linecap: round; stroke-linejoin: round; }

.msg-context-menu {
            position: fixed;
            background: var(--bg-panel);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 0.5rem 0;
            display: none;
            flex-direction: column;
            box-shadow: 0 10px 25px rgba(0,0,0,0.8);
            z-index: 99999;
            width: 150px;
        }

        .msg-context-menu .ctx-item {
            padding: 0.6rem 1rem;
            cursor: pointer;
            transition: background 0.2s;
        }

        .msg-context-menu .ctx-item:hover { background: var(--bg-hover); }

.picker-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--bg-panel);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1rem;
            padding-top: 3.5rem;
            display: none;
            box-shadow: 0 8px 32px rgba(0,0,0,0.8);
            z-index: 1000;
            max-height: 400px;
            overflow-y: auto;
            overflow-x: hidden;
            width: 350px;
        }

        .picker-popup::-webkit-scrollbar {
            width: 6px;
        }
        .picker-popup::-webkit-scrollbar-thumb {
            background: #444;
            border-radius: 10px;
        }

          .picker-popup::-webkit-scrollbar-track {
            background: transparent;
        }

      .close-emoji {
            position: absolute;
            top: 15px;
            right: 15px;
            cursor: pointer;
            color: var(--text-muted);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: color 0.2s;
        }
        .close-emoji:hover { color: var(--danger); }

.emoji-grid {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 12px;
            width: 100%;
            padding-right: 15px;
        }

     .emoji-item {
            font-size: 1.6rem;
            cursor: pointer;
            padding: 5px;
            border-radius: 8px;
            text-align: center;
            transition: background 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .emoji-item:hover { background: var(--bg-hover); }

        .file-preview {
            display: flex;
            align-items: center;
            gap: 8px;
            background: var(--bg-hover);
            padding: 8px 12px;
            border-radius: 8px;
            margin-bottom: 8px;
            font-size: 0.9rem;
        }

        .file-preview button {
            background: transparent;
            border: none;
            color: var(--danger);
            cursor: pointer;
            padding: 4px;
        }

        .blank-chat-state {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-muted);
            font-size: 1.1rem;
        }

.timed-menu {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--bg-panel);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1.5rem;
            display: none;
            flex-direction: column;
            gap: 12px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.7);
            z-index: 2000;
            width: 380px;
        }

        .timed-menu h4 {
            margin: 0;
            font-size: 1.1rem;
            color: var(--text-main);
        }

        .timed-display-box {
            background: #252525;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid var(--border);
            font-size: 0.9rem;
            color: var(--text-muted);
            line-height: 1.6;
        }

        .timed-display-box b {
            color: var(--accent);
        }
        
        .chat-input {
            flex: 1;
            padding: 12px;
            border-radius: 24px;
            border: 1px solid var(--border);
            background: #2a2a2a;
            color: white;
            resize: none;
            height: 46px;
            line-height: 20px;
        }
        .chat-input:focus { outline: none; border-color: var(--accent); }

   
        .ctx-menu {
            position: fixed;
            background: var(--bg-panel);
            border: 1px solid var(--border);
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
            border-radius: 8px;
            z-index: 5000;
            display: none;
            flex-direction: column;
            min-width: 160px;
            overflow: hidden;
            padding: 5px;
        }
        .ctx-item {
            padding: 10px 15px;
            font-size: 0.9rem;
            color: #e2e8f0;
            cursor: pointer;
            border-radius: 4px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .ctx-item:hover { background: var(--bg-hover); }
        .ctx-item.danger { color: var(--danger); }
        .ctx-item.danger:hover { background: rgba(239, 68, 68, 0.1); }

  
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8);
            backdrop-filter: blur(4px);
            display: none;
            align-items: center; justify-content: center;
            z-index: 1000;
        }
        .modal-box {
            background: var(--bg-panel);
            padding: 2rem;
            border-radius: 12px;
            width: 90%; max-width: 450px;
            border: 1px solid var(--border);
        }
        .modal-list { display: flex; flex-direction: column; gap: 0.5rem; max-height: 300px; overflow-y: auto; margin: 1rem 0; }
        .user-row {
            display: flex; align-items: center; gap: 1rem;
            padding: 0.8rem;
            background: #252525;
            border-radius: 8px;
            cursor: pointer;
        }
        .user-row:hover { background: #333; }


        
      
        .hidden { display: none !important; }
        
        .input-area {
            padding: 1.5rem;
            background: var(--bg-panel);
            border-top: 1px solid var(--border);
            display: flex; gap: 10px;
        }

        .input-bar {
            padding: 1.5rem;
            background: var(--bg-panel);
            border-top: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
    </style>
</head>
<body>

    <div id="page-login" class="school-landing">
        <div class="school-header">
            <div class="logo-area">
                <img src="goteborglogo.png" class="logo-img" alt="P√•velund Skolan">
                <div class="school-title">
                    <h1>P√•velund Skolan</h1>
                    <span>Elev Portal</span>
                </div>
            </div>
            <div class="nav-links"> 
                <a href="#">Information</a>
                <a href="#">Hj√§lp</a>
            </div>
        </div>

        <div class="content-wrapper">
            <div class="welcome-text">
                <h2>P√•velundskolan. Grow with us.</h2>
                <p>V√§lkomen till P√•velundskolans elevmilj√∂. F√• tillg√•ng till dina kurser, g√• med i m√∂ten och hantera din akademisk profil h√§r.</p>
            </div>
            
            <div class="login-panel">
                <h3>Elev √Ötkomst</h3>
                <p>Ange din elev identifieringskod f√∂r att forts√§tta.</p>
                
                <div class="form-group">
                    <label>Identifieringskod:</label>
                    <input type="password" id="loginCode" class="form-input" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                </div>
                
                <button onclick="attemptLogin()" class="btn-primary">Forts√§tt</button>
                <div id="loginError" class="error-msg">√Ötkomst nekad: Ogiltiga inloggningsuppgifter</div>
            </div>
        </div>
    </div>

    <div id="page-chat" class="chat-container hidden">
 <div class="app-header">
           <div class="user-profile" onclick="openProfileModal()">
                <div class="avatar" id="myAvatar"></div>
                <span id="myName">Loading...</span>
            </div>

            <div class="panic-settings">
                <span class="panic-shortcut-hint">Panic Shortcut: Ctrl + Shift + P</span>
                <div class="panic-input-group">
                    <input type="text" id="panicUrlInput" class="panic-input" placeholder="https://docs.google.com">
                    <button class="logout-btn" style="padding: 2px 10px;" onclick="updatePanicUrl()">Set</button>
                </div>
            </div>

            <button class="logout-btn" onclick="logout()">Sign Out</button>
        </div>

        <div class="app-body">
            <div class="sidebar">
                <div class="sidebar-tabs">
                    <button class="tab active" onclick="setTab('dms')">Direct Messages</button>
                    <button class="tab" onclick="setTab('groups')">Groups</button>
                </div>
                
                <div id="chatList" class="chat-list">
                    </div>

                <div class="fab-new" onclick="openNewChatModal()">
                    + Add
                </div>
            </div>

            <div class="chat-view">
                <div id="emptyState" class="blank-chat-state">
            Select a chat to start messaging
        </div>

                <div id="activeChat" class="hidden" style="flex:1; display:flex; flex-direction:column; height:100%;">
                    <div class="chat-view-header">
                        <div class="header-info">
                            <div class="avatar" id="currentChatAvatar"></div>
                            <h3 id="currentChatName">Name</h3>
                        </div>
                        <div class="header-actions">
                           
                        </div>
                    </div>

                    <div id="messagesList" class="messages-area">
                        </div> 

                
<div class="input-bar">
                        <div id="filePreview" style="display: none;" class="file-preview">
                            <span id="fileName"></span>
                            <button onclick="clearFile()">‚úï</button>
                        </div>
                        <div style="display: flex; width: 100%; align-items: center; gap: 10px;">
                     <div class="input-actions">
                                <button id="emojiBtn" class="action-btn" onclick="toggleEmojiPicker(event)" title="Add emoji">
                                    <svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"></circle><path d="M8 14s1.5 2 4 2 4-2 4-2"></path><line x1="9" y1="9" x2="9.01" y2="9"></line><line x1="15" y1="9" x2="15.01" y2="9"></line></svg>
                                </button>
                                <button id="fileBtn" class="action-btn" onclick="triggerFileUpload()" title="Attach file">
                                    <svg viewBox="0 0 24 24"><path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"></path></svg>
                                </button>
                                <button id="timedBtn" class="action-btn" onclick="toggleTimedMenu(event)" title="Timed Message">
                                    <svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>
                                </button>
                            </div>
                            <input type="file" id="fileInput" style="display: none;" onchange="handleFileSelect(event)">
                            <input type="text" id="msgInput" class="chat-input" placeholder="Type a message...">
                            <button class="btn-primary" style="width:auto; padding:0 1.5rem; height:46px;" onclick="sendMessage()">Send</button>
                        </div>
                    </div>

              <div id="emojiPicker" class="picker-popup">
                  <span class="close-emoji" onclick="toggleEmojiPicker(event)">
                        <svg viewBox="0 0 24 24" style="width:18px; height:18px; stroke:currentColor; fill:none; stroke-width:2;"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                    </span>
                    <div class="emoji-grid" id="emojiGrid"></div>
                </div>

                    <div id="timedMsgMenu" class="timed-menu">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <h4>Schedule Message</h4>
                       <span class="close-emoji" style="position:static;" onclick="toggleTimedMenu(event)">
                            <svg viewBox="0 0 24 24" style="width:18px; height:18px; stroke:currentColor; fill:none; stroke-width:2;"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                        </span>
                    </div>
                    <div class="timed-display-box">
                        <div>Current Time: <b id="currentTimeLabel">00:00:00</b></div>
                        <div>Message will send at: <b id="scheduledTimeLabel">00:00:00</b></div>
                    </div>
                    <div class="form-group" style="margin:0;">
                        <label>Delay in minutes:</label>
                        <input type="number" id="timedDelayInput" class="form-input" value="1" min="1" oninput="updateTimedDisplay()">
                    </div>
                    <div class="form-group" style="margin:0;">
                        <label>Message text:</label>
                        <input type="text" id="timedTextInput" class="form-input" placeholder="What should I send later?">
                    </div>
                    <button class="btn-primary" onclick="confirmTimedMessage()">Schedule</button>
                </div>

                <div id="msgContextMenu" class="msg-context-menu"></div>

                </div>
            </div>
        </div>
    </div>

    <div id="sidebarContextMenu" class="ctx-menu">
        </div>

    <div id="modalNewChat" class="modal-overlay">
        <div class="modal-box">
            <h3 id="modalTitle">New Message</h3>
            <div id="modalList" class="modal-list"></div>
            <div style="margin-top:1rem; display:flex; gap:10px; justify-content:flex-end;">
                <button class="logout-btn" onclick="closeModals()">Cancel</button>
                <button id="createGroupBtn" class="btn-primary hidden" style="width:auto" onclick="finalizeGroup()">Create</button>
            </div>
        </div>
    </div>

    <div id="modalRename" class="modal-overlay">
        <div class="modal-box">
            <h3>Rename Group</h3>
            <input type="text" id="renameInput" class="form-input" style="margin:1rem 0;">
            <div style="display:flex; gap:10px;">
                <button class="btn-primary" onclick="saveGroupName()">Save</button>
                <button class="logout-btn" onclick="closeModals()">Cancel</button>
            </div>
        </div>
    </div>

    <div id="modalEditMsg" class="modal-overlay">
        <div class="modal-box">
            <h3>Edit Message</h3>
            <input type="text" id="editMsgInput" class="form-input" style="margin:1rem 0;">
            <div style="display:flex; gap:10px;">
                <button class="btn-primary" onclick="saveEditedMessage()">Update</button>
                <button class="logout-btn" onclick="closeModals()">Cancel</button>
            </div>
        </div>
    </div>




<script src="/socket.io/socket.io.js"></script>
<script>
  
    let PANIC_URL = localStorage.getItem('panicUrl') || "https://www.google.com";
    let currentUser = null;
    let currentChatId = null;
    let allChats = []; 
    let allUsers = []; 
    let activeTab = 'dms'; 
    
    const socket = io();

 
    const pageLogin = document.getElementById('page-login');
    const pageChat = document.getElementById('page-chat');
    const loginInput = document.getElementById('loginCode');
    const errorMsg = document.getElementById('loginError');
    const chatListEl = document.getElementById('chatList');
    const messagesListEl = document.getElementById('messagesList');
    const activeChatPanel = document.getElementById('activeChat');
    const emptyStatePanel = document.getElementById('emptyState');
    const ctxMenu = document.getElementById('sidebarContextMenu');
    
    
    const modalNewChat = document.getElementById('modalNewChat');
    const modalRename = document.getElementById('modalRename');
    const modalList = document.getElementById('modalList');
    const modalTitle = document.getElementById('modalTitle');
    const createGroupBtn = document.getElementById('createGroupBtn');

    document.getElementById('panicUrlInput').value = PANIC_URL;

   function updatePanicUrl() {
        let val = document.getElementById('panicUrlInput').value.trim();
        if (!val) return;
        if (!val.startsWith('http')) val = 'https://' + val;
        PANIC_URL = val;
        localStorage.setItem('panicUrl', val);
        alert('Panic URL updated to: ' + PANIC_URL);
    }

    document.addEventListener('keydown', (e) => {
        if (e.ctrlKey && e.shiftKey && (e.key === 'p' || e.key === 'P')) {
            e.preventDefault();
            window.location.replace(PANIC_URL);
        }
    });
  
   function attemptLogin(providedCode) {
    const code = providedCode || loginInput.value.trim();
    if (code) {
        localStorage.setItem('savedLoginCode', code);
        socket.emit('login', code);
        pageLogin.classList.add('hidden');
        pageChat.classList.remove('hidden');
    }
}

socket.on('login_success', (user) => {
    currentUser = user;
    if ("Notification" in window) {
        Notification.requestPermission();
    }
    document.getElementById('myName').innerText = user.name;
    document.getElementById('myAvatar').innerHTML = 
        `<img src="https://ui-avatars.com/api/?name=${user.name}&background=random" alt="">`;
});

    socket.on('login_fail', () => {
        localStorage.removeItem('savedLoginCode');
        pageLogin.classList.remove('hidden');
        pageChat.classList.add('hidden');
        errorMsg.style.display = 'block';
        setTimeout(() => errorMsg.style.display = 'none', 3000);
    });

    socket.on('user_list', (users) => {
        allUsers = users;
    });

    socket.on('chat_exists', (chatId) => {
        alert('You already have a chat with this person!');
        openChat(chatId);
        closeModals();
    });
 
function setTab(tab) {
        activeTab = tab;
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        const tabs = document.querySelectorAll('.tab');
        if(tab === 'dms') tabs[0].classList.add('active');
        else tabs[1].classList.add('active');
        
        currentChatId = null;
        activeChatPanel.style.display = 'none';
        emptyStatePanel.style.display = 'flex';
        
        renderChatList();
    }

   socket.on('update_chats', (chats) => {
        allChats = chats;
        if (currentChatId && !chats.find(c => c.id === currentChatId)) {
            currentChatId = null;
            activeChatPanel.style.display = 'none';
            emptyStatePanel.style.display = 'flex';
        }
        renderChatList();
    });

   function renderChatList() {
        chatListEl.innerHTML = '';
        
        const filtered = allChats.filter(c => {
            if (activeTab === 'groups') return c.type === 'group';
            return c.type === 'dm';
        });

        filtered.forEach(chat => {
            const div = document.createElement('div');
            div.className = `chat-item ${currentChatId === chat.id ? 'active' : ''}`;
            div.onclick = () => openChat(chat.id);
            div.oncontextmenu = (e) => showContextMenu(e, chat.id);
            
            let displayName = chat.name;
            if (chat.type === 'dm') {
                
                const otherUserId = chat.members.find(id => id !== currentUser.id);
                const otherUser = allUsers.find(u => u.id === otherUserId);
                if (otherUser) {
                    displayName = otherUser.name;
                }
            }

            div.innerHTML = `
                <div class="avatar"><span>${displayName.substring(0,2).toUpperCase()}</span></div>
                <div class="chat-info">
                    <div class="chat-name">${displayName}</div>
                    <div class="chat-preview">Click to open</div>
                </div>
            `;
            chatListEl.appendChild(div);
        });
    }

function openChat(id) {
        currentChatId = id;
        const chat = allChats.find(c => c.id === id);
        
        emptyStatePanel.style.display = 'none';
        activeChatPanel.style.display = 'flex';
        activeChatPanel.classList.remove('hidden');
        
        let displayName = chat.name;
        if (chat.type === 'dm') {
            const otherUserId = chat.members.find(mid => mid !== currentUser.id);
            const otherUser = allUsers.find(u => u.id === otherUserId);
            if (otherUser) {
                displayName = otherUser.name;
            }
        }
        
        document.getElementById('currentChatName').innerText = displayName;
        document.getElementById('currentChatAvatar').innerText = displayName.substring(0,2).toUpperCase();
        
        renderChatList(); 
        
        messagesListEl.innerHTML = '<div style="padding:20px; text-align:center; opacity:0.5">Loading...</div>';
        socket.emit('get_messages', id);
    }


    socket.on('history_data', ({ chatId, messages }) => {
        if (chatId !== currentChatId) return;
        messagesListEl.innerHTML = '';
        messages.forEach(msg => renderMessage(msg));
        scrollToBottom();
    });

socket.on('new_msg', ({ chatId, message }) => {
    if (currentChatId === chatId) {
        renderMessage(message);
        scrollToBottom();
    }
    if (currentUser && message.senderId !== currentUser.id) {
        if (Notification.permission === "granted") {
            const n = new Notification(`New message from ${message.senderName}`, {
                body: message.text || "Sent an attachment",
                icon: "goteborglogo.ico"
            });
            n.onclick = () => {
                window.focus();
                if (pageChat.classList.contains('hidden')) {
                    pageLogin.classList.add('hidden');
                    pageChat.classList.remove('hidden');
                }
                openChat(chatId);
            };
        }
    }
});

let lastSendTime = 0;
    function sendMessage() {
        const now = Date.now();
        if (now - lastSendTime < 500) return;
        
        const input = document.getElementById('msgInput');
        const text = input.value.trim();
        if (!text && !selectedFile) return;
        if (!currentChatId) return;

        lastSendTime = now;

        if (selectedFile) {
            const reader = new FileReader();
            reader.onload = function(e) {
                socket.emit('send_msg', { 
                    chatId: currentChatId, 
                    text: text || '',
                    file: {
                        name: selectedFile.name,
                        data: e.target.result,
                        type: selectedFile.type
                    }
                });
                clearFile();
            };
            reader.readAsDataURL(selectedFile);
        } else {
            socket.emit('send_msg', { chatId: currentChatId, text });
        }
        input.value = '';
    }

    document.getElementById('msgInput').addEventListener('keydown', function(e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            sendMessage();
        }
    });

function renderMessage(msg) {
        const isMe = msg.senderId === currentUser.id;
        const div = document.createElement('div');
        div.className = `message ${isMe ? 'sent' : 'received'}`;
        div.dataset.msgId = msg.id;
        
        if (msg.deleted) {
            div.innerHTML = `
                <div class="msg-bubble">
                    <div class="msg-sender">${msg.senderName}</div>
                    <div class="msg-text deleted-text">This message has been deleted</div>
                    <div class="msg-time">${new Date(msg.timestamp).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</div>
                </div>`;
        } else {
            div.addEventListener('contextmenu', (e) => {
                e.preventDefault();
                if (msg.isPlaceholder) return;
                showMessageContextMenu(e, msg.id, isMe, !!msg.file, msg.file);
            });
            
            const editedLabel = msg.edited ? ' <span class="msg-edited">(edited)</span>' : '';
            const msgStyle = msg.isPlaceholder ? 'style="font-style:italic; opacity:0.7;"' : '';
            
            let fileAttachment = '';
            if (msg.file) {
                if (msg.file.type && msg.file.type.startsWith('image/')) {
                    fileAttachment = `<img src="${msg.file.data}" style="max-width:100%; border-radius:8px; margin-top:8px; display:block; cursor:pointer;" onclick="window.open('${msg.file.data}')">`;
                } else {
                    fileAttachment = `<div style="margin-top:8px;padding:8px;background:rgba(0,0,0,0.2);border-radius:6px;font-size:0.85rem;color:white;display:flex;align-items:center;gap:5px;"><span>üìé</span> <span style="overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${msg.file.name}</span></div>`;
                }
            }
            
            div.innerHTML = `
                <div class="msg-bubble">
                    <div class="msg-sender">${msg.senderName}</div>
                    <div class="msg-text" ${msgStyle}>${msg.text}${editedLabel}</div>
                    ${fileAttachment}
                    <div class="msg-time">${new Date(msg.timestamp).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</div>
                </div>`;
        }
        messagesListEl.appendChild(div);
    }
    function scrollToBottom() {
        messagesListEl.scrollTop = messagesListEl.scrollHeight;
    }


    let selectedChatId = null;
    function showContextMenu(e, id) {
        e.preventDefault();
        selectedChatId = id;
        ctxMenu.style.display = 'flex';
        ctxMenu.style.left = e.pageX + 'px';
        ctxMenu.style.top = e.pageY + 'px';
        
        ctxMenu.innerHTML = `
            <div class="ctx-item" onclick="openRenameModal()">Rename</div>
            <div class="ctx-item danger" onclick="deleteChat()">Delete</div>
        `;
    }
    document.addEventListener('click', () => ctxMenu.style.display = 'none');


    let selectedMembers = [];

    function openNewChatModal() {
        modalNewChat.style.display = 'flex';
        modalTitle.innerText = activeTab === 'groups' ? 'New Group' : 'New Direct Message';
        modalList.innerHTML = '';
        selectedMembers = [];
        
        
        allUsers.forEach(u => {
            if (u.id === currentUser.id) return; 
            
            const row = document.createElement('div');
            row.className = 'user-row';
            row.innerHTML = `
                <div class="avatar"><span>${u.name.charAt(0)}</span></div>
                <span>${u.name}</span>
            `;
            row.onclick = () => {
               
                if (selectedMembers.includes(u.id)) {
                    selectedMembers = selectedMembers.filter(id => id !== u.id);
                    row.style.background = '#252525';
                } else {
                    selectedMembers.push(u.id);
                    row.style.background = '#3b82f6'; 
                }
            };
            modalList.appendChild(row);
        });

     
        createGroupBtn.classList.remove('hidden');
    }

function finalizeGroup() {
        if (selectedMembers.length === 0) return alert("Select at least one person!");

        if (activeTab === 'dms') {
            if (selectedMembers.length > 1) {
                return alert("You can only create a DM with one person at a time!");
            }
            const otherUser = allUsers.find(u => u.id === selectedMembers[0]);
            socket.emit('create_chat', { name: otherUser.name, type: 'dm', members: selectedMembers });
        } else {
            const name = prompt("Name this group:");
            if (!name) return;
            socket.emit('create_chat', { name, type: 'group', members: selectedMembers });
        }
        closeModals();
    }

 
    function openRenameModal() {
        modalRename.style.display = 'flex';
    }
    
    function saveGroupName() {
        const input = document.getElementById('renameInput');
        if (input.value && selectedChatId) {
            socket.emit('rename_chat', { chatId: selectedChatId, newName: input.value });
        }
        closeModals();
    }

    function deleteChat() {
        if (confirm("Delete this chat?")) {
            if (selectedChatId === currentChatId) {
                currentChatId = null;
                activeChatPanel.style.display = 'none';
                emptyStatePanel.style.display = 'flex';
            }
            socket.emit('delete_chat', selectedChatId);
        }
    }

  
    function closeModals() {
        document.querySelectorAll('.modal-overlay').forEach(m => m.style.display = 'none');
    }
    
  function logout() {
    localStorage.removeItem('savedLoginCode');
    location.reload();
}

  

 
    let selectedMessageId = null;
    const msgCtxMenu = document.getElementById('msgContextMenu');

function showMessageContextMenu(e, messageId, isMe, isFile, fileObj) {
        selectedMessageId = messageId;
        msgCtxMenu.style.display = 'flex';
        
        const menuWidth = 150;
        const menuHeight = isMe && isFile ? 120 : 80;
        
        let posX = e.clientX;
        let posY = e.clientY;

        if (posX + menuWidth > window.innerWidth) {
            posX = posX - menuWidth;
        }
        
        if (posY + menuHeight > window.innerHeight) {
            posY = posY - menuHeight;
        }

        msgCtxMenu.style.left = posX + 'px';
        msgCtxMenu.style.top = posY + 'px';
        
        let menuHtml = '';
        if (isFile && fileObj) {
            menuHtml += `<div class="ctx-item" onclick="downloadFile('${fileObj.data}', '${fileObj.name}')">Download</div>`;
        }
        if (isMe) {
            menuHtml += `<div class="ctx-item" onclick="editMessage()">Edit</div>`;
            menuHtml += `<div class="ctx-item danger" onclick="deleteMessage()">Delete</div>`;
        }
        
        if (menuHtml === '') {
            msgCtxMenu.style.display = 'none';
        } else {
            msgCtxMenu.innerHTML = menuHtml;
        }
    }

       function editMessage() {
        const msgDiv = document.querySelector(`[data-msg-id="${selectedMessageId}"]`);
        if (!msgDiv) return;
        const textEl = msgDiv.querySelector('.msg-text');
        const currentText = textEl.textContent.replace(' (edited)', '').trim();
        const newText = prompt("Edit message:", currentText);
        if (newText !== null && newText.trim() !== "" && newText !== currentText) {
            socket.emit('edit_msg', { chatId: currentChatId, messageId: selectedMessageId, newText: newText.trim() });
        }
        msgCtxMenu.style.display = 'none';
    }

function downloadFile(data, name) {
        const link = document.createElement('a');
        link.href = data;
        link.download = name;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        msgCtxMenu.style.display = 'none';
    }
    
    function deleteMessage() {
        if (confirm("Delete this message?")) {
            socket.emit('delete_msg', { chatId: currentChatId, messageId: selectedMessageId });
        }
        msgCtxMenu.style.display = 'none';
    }

    socket.on('msg_edited', ({ chatId, messageId, newText }) => {
        if (chatId !== currentChatId) return;
        const msgDiv = document.querySelector(`[data-msg-id="${messageId}"]`);
        if (msgDiv) {
            const textEl = msgDiv.querySelector('.msg-text');
            textEl.innerHTML = newText + ' <span style="font-size:0.75rem;opacity:0.6">(edited)</span>';
        }
    });

  socket.on('msg_deleted', ({ chatId, messageId }) => {
        if (chatId !== currentChatId) return;
        const msgDiv = document.querySelector(`[data-msg-id="${messageId}"]`);
        if (msgDiv) {
            const bubble = msgDiv.querySelector('.msg-bubble');
            bubble.classList.add('deleted');
            bubble.innerHTML = '<div class="msg-text">This message has been deleted</div>';
        }
    });

 
    let selectedFile = null;
    const fileInput = document.getElementById('fileInput');
    const filePreview = document.getElementById('filePreview');
    const emojiPicker = document.getElementById('emojiPicker');
    const emojiGrid = document.getElementById('emojiGrid');

    const emojis = ['üòÄ','üòÉ','üòÑ','üòÅ','üòÜ','üòÖ','ü§£','üòÇ','üôÇ','üôÉ','üòâ','üòä','üòá','ü•∞','üòç','ü§©','üòò','üòó','üòö','üòô','ü•≤','üòã','üòõ','üòú','ü§™','üòù','ü§ë','ü§ó','ü§≠','ü§´','ü§î','ü§ê','ü§®','üòê','üòë','üò∂','üòè','üòí','üôÑ','üò¨','ü§•','üòå','üòî','üò™','ü§§','üò¥','üò∑','ü§í','ü§ï','ü§¢','ü§Æ','ü§ß','ü•µ','ü•∂','ü•¥','üòµ','ü§Ø','ü§†','ü•≥','ü•∏','üòé','ü§ì','üßê','üòï','üòü','üôÅ','‚òπÔ∏è','üòÆ','üòØ','üò≤','üò≥','ü•∫','üò¶','üòß','üò®','üò∞','üò•','üò¢','üò≠','üò±','üòñ','üò£','üòû','üòì','üò©','üò´','ü•±','üò§','üò°','üò†','ü§¨','üëç','üëé','üëè','üôå','üëã','ü§ö','‚úã','üñê','üññ','üëå','ü§å','ü§è','‚úåÔ∏è','ü§û','ü§ü','ü§ò','ü§ô','üëà','üëâ','üëÜ','üëá','‚òùÔ∏è','üëç','üëé','‚úä','üëä','ü§õ','ü§ú','üëè','üôå','üëê','ü§≤','ü§ù','üôè','‚úçÔ∏è','üíÖ','ü§≥','üí™','ü¶æ','ü¶ø','ü¶µ','ü¶∂','üëÇ','ü¶ª','üëÉ','üß†','ü´Ä','ü´Å','ü¶∑','ü¶¥','üëÄ','üëÅ','üëÖ','üëÑ','üíã','ü©∏'];

    emojis.forEach(emoji => {
        const span = document.createElement('span');
        span.className = 'emoji-item';
        span.textContent = emoji;
        span.onclick = () => insertEmoji(emoji);
        emojiGrid.appendChild(span);
    });

function toggleEmojiPicker(e) {
        if (e && e.stopPropagation) e.stopPropagation();
        const picker = document.getElementById('emojiPicker');
        const timed = document.getElementById('timedMsgMenu');
        timed.style.display = 'none';
        const isHidden = picker.style.display === 'none' || picker.style.display === '';
        picker.style.display = isHidden ? 'block' : 'none';
    }


    function insertEmoji(emoji) {
        const input = document.getElementById('msgInput');
        input.value += emoji;
        input.focus();
        emojiPicker.style.display = 'none';
    }

    function triggerFileUpload() {
        fileInput.click();
    }

    function handleFileSelect(event) {
        const file = event.target.files[0];
        if (file) {
            selectedFile = file;
            document.getElementById('fileName').textContent = file.name;
            filePreview.style.display = 'flex';
        }
    }

    function clearFile() {
    selectedFile = null;
    const fIn = document.getElementById('fileInput');
    if(fIn) fIn.value = '';
    filePreview.style.display = 'none';
}

document.addEventListener('click', (e) => {
        const picker = document.getElementById('emojiPicker');
        const menu = document.getElementById('timedMsgMenu');
        const emojiBtn = document.getElementById('emojiBtn');
        const timedBtn = document.getElementById('timedBtn');

        if (!picker.contains(e.target) && !emojiBtn.contains(e.target)) {
            picker.style.display = 'none';
        }
        if (!menu.contains(e.target) && !timedBtn.contains(e.target)) {
            if (menu.style.display === 'flex') {
                clearInterval(timedUpdateInterval);
                menu.style.display = 'none';
            }
        }
        if (!msgCtxMenu.contains(e.target)) {
            msgCtxMenu.style.display = 'none';
        }
    });

    window.addEventListener('load', () => {
    const savedCode = localStorage.getItem('savedLoginCode');
    if (savedCode) {
        attemptLogin(savedCode);
    }
});

    let timedUpdateInterval;

function toggleTimedMenu(e) {
        if (e && e.stopPropagation) e.stopPropagation();
        const menu = document.getElementById('timedMsgMenu');
        const picker = document.getElementById('emojiPicker');
        picker.style.display = 'none';
        const isHidden = menu.style.display === 'none' || menu.style.display === '';
        menu.style.display = isHidden ? 'flex' : 'none';
        
        if (isHidden) {
            updateTimedDisplay();
            timedUpdateInterval = setInterval(updateTimedDisplay, 1000);
        } else {
            clearInterval(timedUpdateInterval);
        }
    }


    function updateTimedDisplay() {
        const now = new Date();
        const delay = parseInt(document.getElementById('timedDelayInput').value) || 0;
        const future = new Date(now.getTime() + delay * 60000);
        
        document.getElementById('currentTimeLabel').innerText = now.toLocaleTimeString();
        document.getElementById('scheduledTimeLabel').innerText = future.toLocaleTimeString();
    }

    function confirmTimedMessage() {
        const delay = parseInt(document.getElementById('timedDelayInput').value);
        const text = document.getElementById('timedTextInput').value.trim();
        
        if (!text) return alert("Enter a message");
        if (!delay || delay < 1) return alert("Enter valid minutes");
        if (!currentChatId) return alert("Select a chat first");

        socket.emit('schedule_msg', {
            chatId: currentChatId,
            text: text,
            delayMs: delay * 60000
        });

        alert(`Message scheduled to send in ${delay} minutes.`);
        document.getElementById('timedTextInput').value = '';
        toggleTimedMenu();
    }
</script>

</body>
</html>
